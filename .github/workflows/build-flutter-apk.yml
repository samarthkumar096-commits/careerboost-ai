name: Build Flutter APK

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'mobile-flutter/**'

env:
  FLUTTER_VERSION: '3.16.0'

jobs:
  build:
    name: Build Flutter Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ— Checkout repository
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: ğŸ“¦ Get dependencies
      working-directory: ./mobile-flutter
      run: flutter pub get
    
    - name: ğŸ” Analyze code
      working-directory: ./mobile-flutter
      run: flutter analyze
    
    - name: ğŸ§ª Run tests
      working-directory: ./mobile-flutter
      run: flutter test || true
    
    - name: ğŸ”¨ Build APK
      working-directory: ./mobile-flutter
      run: flutter build apk --release --split-per-abi
    
    - name: ğŸ“± Build App Bundle
      working-directory: ./mobile-flutter
      run: flutter build appbundle --release
    
    - name: ğŸ“¤ Upload APK (arm64-v8a)
      uses: actions/upload-artifact@v4
      with:
        name: app-arm64-v8a-release
        path: mobile-flutter/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
    
    - name: ğŸ“¤ Upload APK (armeabi-v7a)
      uses: actions/upload-artifact@v4
      with:
        name: app-armeabi-v7a-release
        path: mobile-flutter/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
    
    - name: ğŸ“¤ Upload APK (x86_64)
      uses: actions/upload-artifact@v4
      with:
        name: app-x86_64-release
        path: mobile-flutter/build/app/outputs/flutter-apk/app-x86_64-release.apk
    
    - name: ğŸ“¤ Upload App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: app-release-bundle
        path: mobile-flutter/build/app/outputs/bundle/release/app-release.aab
    
    - name: ğŸ“Š Get APK info
      working-directory: ./mobile-flutter
      run: |
        echo "ğŸ“± APK Build Information:"
        echo "========================"
        ls -lh build/app/outputs/flutter-apk/
        echo ""
        echo "ğŸ“¦ App Bundle Information:"
        ls -lh build/app/outputs/bundle/release/
    
    - name: âœ… Build success notification
      if: success()
      run: |
        echo "::notice title=Build Success::Flutter APK built successfully! Download from artifacts."
    
    - name: âŒ Build failure notification
      if: failure()
      run: |
        echo "::error title=Build Failed::Flutter APK build failed. Check logs for details."
