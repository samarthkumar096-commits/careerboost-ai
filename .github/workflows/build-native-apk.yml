name: Build Real Native APK with EAS

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'mobile-native/**'

env:
  NODE_VERSION: '18'
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build:
    name: Build Native Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ— Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ— Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: mobile-native/package-lock.json
    
    - name: ğŸ“¦ Install ImageMagick for asset generation
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
    
    - name: ğŸ— Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}
    
    - name: ğŸ“¦ Install dependencies
      working-directory: ./mobile-native
      run: |
        npm ci --legacy-peer-deps || npm install --legacy-peer-deps
        echo "âœ… Dependencies installed"
    
    - name: ğŸ¨ Generate app assets
      working-directory: ./mobile-native
      run: |
        mkdir -p assets
        
        # Generate icon (1024x1024)
        convert -size 1024x1024 \
          -define gradient:angle=135 \
          gradient:"#8B5CF6-#7C3AED" \
          -gravity center \
          -pointsize 200 \
          -fill white \
          -annotate +0+0 "CB" \
          assets/icon.png
        
        # Copy for adaptive icon
        cp assets/icon.png assets/adaptive-icon.png
        
        # Generate splash screen (1284x2778)
        convert -size 1284x2778 \
          -define gradient:angle=135 \
          gradient:"#8B5CF6-#7C3AED" \
          -gravity center \
          -pointsize 120 \
          -fill white \
          -annotate +0-200 "CareerBoost AI" \
          -pointsize 60 \
          -annotate +0+200 "AI-Powered Resume Builder" \
          assets/splash.png
        
        # Generate favicon (48x48)
        convert -size 48x48 \
          gradient:"#8B5CF6-#7C3AED" \
          assets/favicon.png
        
        echo "âœ… Assets generated successfully"
        ls -lh assets/
    
    - name: ğŸ”§ Verify Expo configuration
      working-directory: ./mobile-native
      run: |
        echo "Verifying Expo project..."
        npx expo-cli doctor || true
        echo "âœ… Configuration verified"
    
    - name: ğŸš€ Build APK with EAS
      working-directory: ./mobile-native
      run: |
        echo "ğŸš€ Starting EAS Build..."
        echo "Platform: Android"
        echo "Profile: preview"
        echo "Build Type: APK"
        
        eas build \
          --platform android \
          --profile preview \
          --non-interactive \
          --clear-cache \
          --wait
        
        echo "âœ… Build completed successfully!"
    
    - name: ğŸ“± Get build information
      if: success()
      working-directory: ./mobile-native
      run: |
        echo "ğŸ“± Build Information:"
        echo "===================="
        eas build:list --platform android --limit 1
        echo ""
        echo "âœ… APK is ready for download!"
        echo "ğŸ”— Visit: https://expo.dev"
        echo "ğŸ“± Login and check your builds"
    
    - name: ğŸ’¬ Build success notification
      if: success()
      run: |
        echo "::notice title=Build Success::Native Android APK built successfully! Download from Expo dashboard."
    
    - name: âŒ Build failure notification
      if: failure()
      run: |
        echo "::error title=Build Failed::APK build failed. Check logs for details."
